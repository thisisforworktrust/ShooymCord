<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shooym Voice</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    :root { --bg-tertiary: #1e1f22; --bg-secondary: #2b2d31; --bg-primary: #313338; --text-normal: #dbdee1; --accent: #5865f2; --green: #23a559; --red: #fa777c; --control-bg: #2b2d31; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg-primary); color: var(--text-normal); font-family: 'gg sans', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* Header Styles */
    .header { height: 48px; background: var(--bg-secondary); border-bottom: 1px solid #1f2023; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-weight: bold; -webkit-app-region: drag; }
    
    .status-group { display: flex; align-items: center; gap: 16px; }
    .status-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    
    /* Timer Style */
    .timer-badge { font-family: monospace; font-size: 1rem; color: var(--text-normal); background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; }
    
    .ping-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; }
    .ping-dot.connecting { background: #faa61a; }
    .ping-dot.offline { background: var(--red); }
    
    .voice-grid { flex: 1; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; align-content: flex-start; overflow-y: auto; }
    .voice-user { background: var(--bg-secondary); border-radius: 8px; padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 2px solid transparent; transition: 0.2s; }
    .voice-user.speaking { border-color: var(--green); }
    .avatar-wrapper { position: relative; width: 64px; height: 64px; margin-bottom: 8px; }
    .avatar { width: 100%; height: 100%; border-radius: 50%; background: #555; object-fit: cover; }
    .username { font-weight: bold; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    
    .controls { height: 80px; background: #1e1f22; display: flex; align-items: center; justify-content: center; gap: 24px; padding-bottom: 10px; position: relative; z-index: 10; }
    .control-btn { width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; color: white; }
    .btn-normal { background: var(--bg-secondary); color: var(--text-normal); }
    .btn-normal:hover { background: #3f4147; }
    .btn-active { background: white; color: black; }
    .btn-disconnect { background: var(--red); }
    .btn-disconnect:hover { background: #d8454b; }
    #audio-grid { display: none; }

    /* SPINNING BEEF STYLES */
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .spinning-beef {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 100px;
        height: auto;
        animation: spin 4s linear infinite;
        /* UPDATED Z-INDEX TO 100 SO IT IS ON TOP OF CONTROLS */
        z-index: 100; 
        pointer-events: none; 
    }
</style>
</head>
<body>
    <div class="header">
        <div class="status-indicator">
            <i class="fa-solid fa-volume-high"></i> 
            <span>General</span>
        </div>
        
        <div class="status-group">
            <div class="status-indicator">
                <span id="call-timer" class="timer-badge">00:00</span>
            </div>
            
            <div class="status-indicator">
                <div id="status-dot" class="ping-dot offline"></div>
                <span id="connection-status">Ready</span>
            </div>
        </div>
    </div>

    <div class="voice-grid" id="user-grid"></div>

    <img src="beef.png" alt="Spinning Beef" class="spinning-beef">

    <div class="controls">
        <button id="btn-mute" class="control-btn btn-normal" onclick="toggleMute()"><i class="fa-solid fa-microphone"></i></button>
        <button id="btn-hangup" class="control-btn btn-disconnect" onclick="hangUp()"><i class="fa-solid fa-phone-slash"></i></button>
    </div>
    
    <div id="audio-grid"></div>

    <script>
    const ROOM_ID = "shooym-voice-general-v1";
    let peer, localStream, connectedPeers = new Set(), isMuted = false;
    let callTimerInterval;
    
    const statusDot = document.getElementById("status-dot"), 
          statusText = document.getElementById("connection-status"), 
          userGrid = document.getElementById("user-grid"), 
          muteBtn = document.getElementById("btn-mute"),
          timerEl = document.getElementById("call-timer");
    
    window.onload = startCall;
    
    async function startCall() {
        statusDot.className = "ping-dot connecting"; statusText.innerText = "Connecting...";
        try { 
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
            addUser("You", true); 
            initPeer(); 
        } catch (err) { 
            statusText.innerText = "Mic Denied"; 
            statusDot.className = "ping-dot offline"; 
            alert("Mic required."); 
        }
    }

    function initPeer() {
        peer = new Peer(ROOM_ID);
        peer.on("open", id => { setConnectedState(); setupHost(); });
        peer.on("error", err => { 
            if (err.type === "unavailable-id") { 
                peer = new Peer(); 
                peer.on("open", id => { setConnectedState(); setupClient(); }); 
            } 
        });
    }

    function setupHost() {
        peer.on("call", call => { call.answer(localStream); attachAudio(call); });
        peer.on("connection", conn => { 
            connectedPeers.add(conn.peer); 
            setTimeout(() => { conn.send({ peers: [...connectedPeers] }); }, 500); 
            conn.on("close", () => { connectedPeers.delete(conn.peer); removeUser(conn.peer); }); 
        });
    }

    function setupClient() {
        const conn = peer.connect(ROOM_ID);
        conn.on("open", () => { const hostCall = peer.call(ROOM_ID, localStream); attachAudio(hostCall); });
        conn.on("data", data => { 
            if (data.peers) { 
                data.peers.forEach(id => { 
                    if (id !== peer.id) { attachAudio(peer.call(id, localStream)); } 
                }); 
            } 
        });
        peer.on("call", call => { call.answer(localStream); attachAudio(call); });
    }

    function attachAudio(call) {
        call.on("stream", stream => {
            if (document.getElementById("audio-" + call.peer)) return;
            const audio = document.createElement("audio"); 
            audio.id = "audio-" + call.peer; 
            audio.srcObject = stream; 
            audio.playsInline = true; 
            document.getElementById("audio-grid").appendChild(audio); 
            audio.play().catch(e=>{});
            addUser(call.peer, false); 
            setupVAD(stream, call.peer);
        });
        call.on("close", () => removeUser(call.peer));
    }

    function setupVAD(stream, id) {
        const ctx = new AudioContext();
        const src = ctx.createMediaStreamSource(stream);
        const proc = ctx.createScriptProcessor(2048, 1, 1);
        src.connect(proc); proc.connect(ctx.destination);
        proc.onaudioprocess = e => {
            const input = e.inputBuffer.getChannelData(0); let sum = 0;
            for (let i = 0; i < input.length; i++) sum += input[i] * input[i];
            const el = document.getElementById("ui-" + id);
            if(el) { 
                if(Math.sqrt(sum / input.length) > 0.02) el.classList.add("speaking"); 
                else el.classList.remove("speaking"); 
            }
        };
    }

    function setConnectedState() { 
        statusDot.className = "ping-dot"; 
        statusText.innerText = "Connected";
        startTimer();
    }

    function startTimer() {
        let seconds = 0;
        if(callTimerInterval) clearInterval(callTimerInterval);
        
        callTimerInterval = setInterval(() => {
            seconds++;
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            let timeString = "";
            if(hrs > 0) timeString += hrs + ":";
            timeString += (mins < 10 ? "0" : "") + mins + ":";
            timeString += (secs < 10 ? "0" : "") + secs;
            
            timerEl.innerText = timeString;
        }, 1000);
    }
    
    function addUser(id, isSelf) {
        if(document.getElementById("ui-" + id)) return;
        const safeName = isSelf ? "You" : id.substring(0, 5);
        const div = document.createElement("div"); 
        div.className = "voice-user"; 
        div.id = "ui-" + id;
        div.innerHTML = `<div class="avatar-wrapper"><img src="https://ui-avatars.com/api/?name=${safeName}&background=random" class="avatar"></div><div class="username">${safeName}</div>`;
        userGrid.appendChild(div);
    }

    function removeUser(id) { 
        document.getElementById("ui-" + id)?.remove(); 
        document.getElementById("audio-" + id)?.remove(); 
    }

    function toggleMute() {
        if(!localStream) return; 
        isMuted = !isMuted; 
        localStream.getAudioTracks()[0].enabled = !isMuted;
        muteBtn.innerHTML = isMuted ? '<i class="fa-solid fa-microphone-slash"></i>' : '<i class="fa-solid fa-microphone"></i>';
        if(isMuted) muteBtn.classList.add("btn-active"); else muteBtn.classList.remove("btn-active");
    }

    function hangUp() { 
        if(callTimerInterval) clearInterval(callTimerInterval);
        if(localStream) localStream.getTracks().forEach(t=>t.stop()); 
        if(peer) peer.destroy(); 
        window.close(); 
    }
    </script>
</body>
</html>

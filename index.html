<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShooymCord</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

<style>
:root { --bg-tertiary: #1e1f22; --bg-secondary: #2b2d31; --bg-primary: #313338; --header-primary: #f2f3f5; --header-secondary: #949ba4; --text-normal: #dbdee1; --accent: #5865f2; --input-bg: #383a40; --green: #23a559; --red: #fa777c; }
* { box-sizing: border-box; }
body { margin: 0; background: var(--bg-primary); color: var(--text-normal); font-family: 'gg sans', sans-serif; height: 100vh; overflow: hidden; display: flex; }

/* Scrollbars */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #2b2d31; }
::-webkit-scrollbar-thumb { background: #1a1b1e; border-radius: 4px; }

/* Server List */
.servers { width: 72px; background: var(--bg-tertiary); display: flex; flex-direction: column; align-items: center; padding-top: 12px; gap: 8px; }
.server-icon { width: 48px; height: 48px; background-color: var(--bg-primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; color: var(--text-normal); position: relative; }
.server-icon.active { border-radius: 16px; background-color: var(--accent); color: white; }

/* Channels */
.channels { width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column; }
.server-header { height: 48px; padding: 0 16px; display: flex; align-items: center; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); color: var(--header-primary); }
.channel-list { padding: 8px; flex: 1; overflow-y: auto; }
.channel-item { padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; color: var(--header-secondary); cursor: pointer; display: flex; align-items: center; gap: 6px; }
.channel-item.active { background: rgba(88, 101, 242, 0.3); color: white; }
.user-bar { background: #232428; height: 52px; padding: 0 8px; display: flex; align-items: center; gap: 8px; }
.user-avatar-small { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; }
.user-info { flex: 1; font-size: 0.85rem; font-weight: bold; overflow: hidden; }

/* Chat Area */
.chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); position: relative; }
.chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 0 rgba(4,4,5,0.2); font-weight: bold; color: var(--header-primary); }
#chat-feed { flex: 1; overflow-y: auto; padding: 16px 0; display: flex; flex-direction: column; }
.message { padding: 4px 16px; margin-top: 4px; display: flex; gap: 16px; }
.message:hover { background: rgba(4, 4, 5, 0.07); }
.avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; background: #555; }
.message-header { display: flex; align-items: baseline; gap: 8px; }
.username { font-weight: 500; color: #fff; cursor: pointer; }
.timestamp { font-size: 0.7rem; color: var(--header-secondary); }
.message-text { color: var(--text-normal); font-size: 1rem; line-height: 1.375rem; white-space: pre-wrap; word-wrap: break-word; }
.input-area { padding: 0 16px 24px; background: var(--bg-primary); }
.input-wrapper { background: var(--input-bg); border-radius: 8px; display: flex; align-items: center; padding: 10px 16px; }
#msg-input { background: transparent; border: none; color: var(--text-normal); outline: none; width: 100%; font-family: inherit; font-size: 1rem; }

/* Role Indicator */
#role-badge { 
    padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: white; font-weight: bold; 
    text-transform: uppercase; letter-spacing: 0.5px;
}
.role-host { background: var(--green); }
.role-client { background: var(--accent); }
.role-offline { background: var(--red); }
</style>
</head>
<body>

<nav class="servers">
    <div class="server-icon active"><i class="fa-brands fa-discord"></i></div>
</nav>

<div class="channels">
    <div class="server-header" id="server-name">Shooym Community</div>
    <div class="channel-list">
        <div class="channel-item active"><span style="color:#888">#</span> general</div>
        <div class="channel-item"><span style="color:#888">#</span> memes</div>
    </div>
    
    <div class="user-bar">
        <img src="" id="current-user-avatar" class="user-avatar-small" onclick="changeName()" title="Click to Change Name">
        <div class="user-info">
            <div id="display-username">...</div>
            <div style="font-size: 0.7rem; color: #aaa;">Online</div>
        </div>
    </div>
</div>

<main class="chat-area">
    <header class="chat-header">
        <div><span style="color:var(--header-secondary); margin-right: 4px;">#</span> general</div>
        <div id="role-badge" class="role-offline">Connecting...</div>
    </header>

    <div id="chat-feed"></div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="Initializing..." disabled>
            <button onclick="clearMyHistory()" style="background:none; border:none; color:#aaa; cursor:pointer;" title="Clear Local History"><i class="fa-solid fa-trash"></i></button>
        </div>
    </div>
</main>

<script>
    // --- CONFIGURATION ---
    const SHARED_SERVER_ID = "shooym-global-room-v3"; 
    const STORAGE_KEY = "shooym_universal_history_v1";

    // --- STATE ---
    let myName = localStorage.getItem("shooym_username");
    if(!myName) {
        myName = prompt("Enter Username:", "User" + Math.floor(Math.random()*100));
        if(!myName) myName = "Anon";
        localStorage.setItem("shooym_username", myName);
    }
    
    let peer = null;
    let myRole = "offline"; 
    let connections = [];   
    let hostConn = null;    
    let messageHistory = [];

    // --- STARTUP ---
    updateUI(myName);
    loadHistory(); 

    // 1. Try to be the HOST first
    console.log("Attempting to become Host...");
    peer = new Peer(SHARED_SERVER_ID);

    peer.on('open', (id) => {
        becomeHost(id);
    });

    peer.on('error', (err) => {
        if(err.type === 'unavailable-id') {
            console.log("Host exists. Switching to Client mode.");
            becomeClient();
        } else {
            console.error("Peer Error:", err);
        }
    });

    // --- HOST LOGIC ---
    function becomeHost(id) {
        myRole = 'host';
        updateRoleDisplay("HOST (Server)");
        enableChat();
        
        peer.on('connection', (conn) => {
            connections.push(conn);
            
            conn.on('open', () => {
                // Send history to the new person
                if(messageHistory.length > 0) {
                    messageHistory.forEach(msg => conn.send(msg));
                }
            });

            conn.on('data', (data) => {
                // 1. Save to MY storage (and check for duplicates)
                const isNew = handleIncomingMessage(data);
                
                // 2. Broadcast to everyone else ONLY if it was new to me
                // (This prevents infinite loops of re-broadcasting old messages)
                if (isNew) {
                    broadcast(data); 
                }
            });

            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
            });
        });
    }

    function broadcast(data) {
        connections.forEach(c => {
            if(c.open) c.send(data);
        });
    }

    // --- CLIENT LOGIC ---
    function becomeClient() {
        peer = new Peer(); 
        
        peer.on('open', () => {
            myRole = 'client';
            connectToHost();
        });
    }

    function connectToHost() {
        updateRoleDisplay("Connecting to Host...");
        hostConn = peer.connect(SHARED_SERVER_ID);

        hostConn.on('open', () => {
            updateRoleDisplay("Connected to Chat");
            enableChat();
        });

        hostConn.on('data', (data) => {
            handleIncomingMessage(data);
        });

        hostConn.on('close', () => {
            updateRoleDisplay("Host Disconnected");
            disableChat();
            setTimeout(connectToHost, 3000); // Retry logic
        });
        
        peer.on('error', (err) => {
            setTimeout(connectToHost, 3000);
        });
    }

    // --- MESSAGE HANDLING (THE FIX) ---
    
    function handleIncomingMessage(data) {
        // --- DUPLICATE CHECKER ---
        // We check if we have a message with the same ID
        // OR (for old messages) same timestamp + text
        const exists = messageHistory.some(m => 
            (m.id && m.id === data.id) || 
            (!m.id && m.timestamp === data.timestamp && m.msg === data.msg)
        );

        if (exists) {
            return false; // STOP! Do not render, do not save.
        }

        // If we get here, it is a NEW message
        messageHistory.push(data);
        saveToStorage();
        renderMessage(data);
        return true; // Report success
    }

    function sendMessage() {
        const text = msgInput.value.trim();
        if (!text) return;

        // CREATE MESSAGE WITH UNIQUE ID
        const msgData = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            user: myName,
            msg: text,
            timestamp: Date.now()
        };

        // 1. Show & Save Locally
        handleIncomingMessage(msgData);

        // 2. Send over network
        if (myRole === 'host') {
            broadcast(msgData);
        } else if (myRole === 'client' && hostConn && hostConn.open) {
            hostConn.send(msgData);
        }

        msgInput.value = '';
    }

    // --- STORAGE SYSTEM ---
    function loadHistory() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                messageHistory = JSON.parse(saved);
                const feed = document.getElementById('chat-feed');
                feed.innerHTML = ''; 
                messageHistory.forEach(msg => renderMessage(msg));
            }
        } catch(e) { console.error("Load error", e); }
    }

    function saveToStorage() {
        // Limit to 500 messages
        if(messageHistory.length > 500) messageHistory.shift();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(messageHistory));
    }

    function clearMyHistory() {
        if(confirm("Clear your LOCAL chat history?")) {
            localStorage.removeItem(STORAGE_KEY);
            messageHistory = [];
            document.getElementById('chat-feed').innerHTML = '';
        }
    }

    // --- UI FUNCTIONS ---
    const msgInput = document.getElementById('msg-input');
    msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    function enableChat() {
        msgInput.disabled = false;
        msgInput.placeholder = `Message #${document.querySelector('.channel-item.active').innerText.replace('# ','')}`;
        msgInput.focus();
    }
    
    function disableChat() {
        msgInput.disabled = true;
        msgInput.placeholder = "Searching for connection...";
    }

    function updateRoleDisplay(statusText) {
        const badge = document.getElementById('role-badge');
        badge.innerText = statusText;
        badge.className = ""; 
        if(myRole === 'host') badge.classList.add('role-host');
        else if(statusText.includes("Connected")) badge.classList.add('role-client');
        else badge.classList.add('role-offline');
    }

    function renderMessage(data) {
        const feed = document.getElementById('chat-feed');
        const date = new Date(data.timestamp || Date.now());
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user)}&background=random`;

        const msgHTML = `
            <div class="message">
                <img src="${avatarUrl}" class="avatar">
                <div class="message-content">
                    <div class="message-header">
                        <span class="username">${data.user}</span>
                        <span class="timestamp">${timeStr}</span>
                    </div>
                    <div class="message-text">${data.msg}</div>
                </div>
            </div>`;

        feed.innerHTML += msgHTML;
        feed.scrollTop = feed.scrollHeight;
    }

    function updateUI(name) {
        document.getElementById('display-username').innerText = name;
        document.getElementById('current-user-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=232428&color=fff`;
    }

    function changeName() {
        let newName = prompt("New Username:", myName);
        if(newName) {
            myName = newName;
            localStorage.setItem("shooym_username", myName);
            updateUI(myName);
        }
    }
</script>
</body>
</html>
